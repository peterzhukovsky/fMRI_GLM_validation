files={'1001_11655';'1003_14296';'1004_16928';'1005_17287';'1006_17291';'1007_14061';'1009_17577';'1010_17576';'1011_16073';'1012_17636';'1014_14693';'1016_17713';'1018_10058';'1023_17782';'1025_17828';'1026_17851';'1027_17863';'1028_17891';'1031_17970';'1032_18093';'1033_18300';'1034_18299';'1035_18307';'1036_18308';'1037_18561';'1038_60';'1039_18683';'1040_18697';'1044_18905';'1045_18899';'1046_18981';'1047_18992';'1050_19088';'1051_19132';'1052_19143';'2001_16758';'2002_13502';'2003_16821';'2004_11623';'2005_17034';'2006_17290';'2007_17286';'2008_16846';'2009_17295';'2010_17605';'2013_17711';'2014_17708';'2015_17733';'2016_17750';'2017_17861';'2018_17912';'2019_17928';'2021_17910';'2022_17990';'2024_18070';'2025_18087';'2026_18112';'2027_18080';'2028_18164';'2029_18135';'2030_18199';'2032_18413';'2035_18443';'2036_18479';'2037_18528';'2038_18486';'2039_18544';'2040_18548';'2041_18657';'2042_18680';'2044_18726';'2046_18801';'2047_18838';'2049_18975';'2050_18998';'2051_19059';'3001_16759';'3002_16697';'3003_16820';'3004_16760';'3005_17030';'3006_17289';'3007_17285';'3008_16845';'3010_17604';'3011_17678';'3012_17705';'3014_17707';'3015_17732';'3016_17749';'3017_17860';'3018_17911';'3019_17927';'3020_17919';'3021_17909';'3022_17991';'3023_18000';'3024_18069';'3025_18086';'3026_18111';'3027_18079';'3028_18163';'3029_18134';'3030_18198';'3031_18327';'3033_18445';'3034_18492';'3035_18442';'3036_18478';'3038_18485';'3039_18543';'3040_18547';'3041_18656';'3042_18679';'3045_18766';'3046_18800';'3047_18837';'3048_18958';'3049_18974';'3050_18997';'3051_19058';'4001_19399';'4004_19406';'4005_19400';'4006_19410';'4007_19501';'4008_19511';'4010_19560';'4011_19595';'4012_19607';'4013_19616';'4014_19621';'4015_19660';'4017_19737';'4018_19759';'4019_19390';'4020_19661';'4021_19891';'4022_19928';'4023_19957';'4024_19943';'4025_19415';'4026_19944';'4027_19933';'4028_20068';'4029_20137'};
files_long={'mid_1001_11655.csv';'mid_1003_14296.csv';'mid_1004_16928.csv';'mid_1005_17287.csv';'mid_1006_17291.csv';'mid_1007_14061.csv';'mid_1009_17577.csv';'mid_1010_17576.csv';'mid_1011_16073.csv';'mid_1012_17636.csv';'mid_1014_14693.csv';'mid_1016_17713.csv';'mid_1018_10058.csv';'mid_1023_17782.csv';'mid_1025_17828.csv';'mid_1026_17851.csv';'mid_1027_17863.csv';'mid_1028_17891.csv';'mid_1031_17970.csv';'mid_1032_18093.csv';'mid_1033_18300.csv';'mid_1034_18299.csv';'mid_1035_18307.csv';'mid_1036_18308.csv';'mid_1037_18561.csv';'mid_1038_60.csv';'mid_1039_18683.csv';'mid_1040_18697.csv';'mid_1044_18905.csv';'mid_1045_18899.csv';'mid_1046_18981.csv';'mid_1047_18992.csv';'mid_1050_19088.csv';'mid_1051_19132.csv';'mid_1052_19143.csv';'mid_2001_16758.csv';'mid_2002_13502.csv';'mid_2003_16821.csv';'mid_2004_11623.csv';'mid_2005_17034.csv';'mid_2006_17290.csv';'mid_2007_17286.csv';'mid_2008_16846.csv';'mid_2009_17295.csv';'mid_2010_17605.csv';'mid_2013_17711.csv';'mid_2014_17708.csv';'mid_2015_17733.csv';'mid_2016_17750.csv';'mid_2017_17861.csv';'mid_2018_17912.csv';'mid_2019_17928.csv';'mid_2021_17910.csv';'mid_2022_17990.csv';'mid_2024_18070.csv';'mid_2025_18087.csv';'mid_2026_18112.csv';'mid_2027_18080.csv';'mid_2028_18164.csv';'mid_2029_18135.csv';'mid_2030_18199.csv';'mid_2032_18413.csv';'mid_2035_18443.csv';'mid_2036_18479.csv';'mid_2037_18528.csv';'mid_2038_18486.csv';'mid_2039_18544.csv';'mid_2040_18548.csv';'mid_2041_18657.csv';'mid_2042_18680.csv';'mid_2044_18726.csv';'mid_2046_18801.csv';'mid_2047_18838.csv';'mid_2049_18975.csv';'mid_2050_18998.csv';'mid_2051_19059.csv';'mid_3001_16759.csv';'mid_3002_16697.csv';'mid_3003_16820.csv';'mid_3004_16760.csv';'mid_3005_17030.csv';'mid_3006_17289.csv';'mid_3007_17285.csv';'mid_3008_16845.csv';'mid_3010_17604.csv';'mid_3011_17678.csv';'mid_3012_17705.csv';'mid_3014_17707.csv';'mid_3015_17732.csv';'mid_3016_17749.csv';'mid_3017_17860.csv';'mid_3018_17911.csv';'mid_3019_17927.csv';'mid_3020_17919.csv';'mid_3021_17909.csv';'mid_3022_17991.csv';'mid_3023_18000.csv';'mid_3024_18069.csv';'mid_3025_18086.csv';'mid_3026_18111.csv';'mid_3027_18079.csv';'mid_3028_18163.csv';'mid_3029_18134.csv';'mid_3030_18198.csv';'mid_3031_18327.csv';'mid_3033_18445.csv';'mid_3034_18492.csv';'mid_3035_18442.csv';'mid_3036_18478.csv';'mid_3038_18485.csv';'mid_3039_18543.csv';'mid_3040_18547.csv';'mid_3041_18656.csv';'mid_3042_18679.csv';'mid_3045_18766.csv';'mid_3046_18800.csv';'mid_3047_18837.csv';'mid_3048_18958.csv';'mid_3049_18974.csv';'mid_3050_18997.csv';'mid_3051_19058.csv';'mid_4001_19399.csv';'mid_4004_19406.csv';'mid_4005_19400.csv';'mid_4006_19410.csv';'mid_4007_19501.csv';'mid_4008_19511.csv';'mid_4010_19560.csv';'mid_4011_19595.csv';'mid_4012_19607.csv';'mid_4013_19616.csv';'mid_4014_19621.csv';'mid_4015_19660.csv';'mid_4017_19737.csv';'mid_4018_19759.csv';'mid_4019_19390.csv';'mid_4020_19661.csv';'mid_4021_19891.csv';'mid_4022_19928.csv';'mid_4023_19957.csv';'mid_4024_19943.csv';'mid_4025_19415.csv';'mid_4026_19944.csv';'mid_4027_19933.csv';'mid_4028_20068.csv';'mid_4029_20137.csv'};
%'1013_17645';'1015_17694';'1017_17718';'1024_17810';'1020_17756';'1021_17765';'1022_17777';'1041_18717';'1042_16561';
files_short=char(files);
files_short=cellstr(files_short(:,1:4));
files_short=cell2mat(files_short);

    IFG_all=[];
    acc_all=[];
    CAU_all=[];
    pO_all=[];
    trial_type_all=[]; subject_id_all=[];  rIFG_plot_all=[];
for i=36:76
    clear rIFG_plot subject_id start_time end_time rIFG_time xq ts_name rIFG_activation acc_activation CAU_activation pO_activation trial_type trial_rIGT_interp
%importing and interpolating the ts data
%RAW_ts: %ts_name=strcat('G:\Impulsivity_project\DCM\MID\', files(i), '\rIFG_ts.txt'); rIFG=dlmread(char(ts_name(:)));
load(char(strcat('G:\Impulsivity_project\DCM\MID\', files(i),'\Deconv_DRUG_rIFG_ts_deconv')))
rIFG=data_deconv; rIFG=rIFG(1:660); rIFG_time=(2:2:1320); xq = 1:0.01:1320;
rIFG_interp = interp1(rIFG_time,rIFG,xq,'spline');

load(char(strcat('G:\Impulsivity_project\DCM\MID\', files(i),'\Deconv_DRUG_ACC_ts_deconv')))
acc=data_deconv; acc=acc(1:660); acc_time=(2:2:1320); xq = 1:0.01:1320;
acc_interp = interp1(acc_time,acc,xq,'spline');

load(char(strcat('G:\Impulsivity_project\DCM\MID\', files(i),'\Deconv_DRUG_CAU_ts_deconv')))
CAU=data_deconv; CAU=CAU(1:660); CAU_time=(2:2:1320); xq = 1:0.01:1320;
CAU_interp = interp1(CAU_time,CAU,xq,'spline');

load(char(strcat('G:\Impulsivity_project\DCM\MID\', files(i),'\Deconv_DRUG_pO_ts_deconv')))
pO=data_deconv; pO=pO(1:660); pO_time=(2:2:1320); xq = 1:0.01:1320;
pO_interp = interp1(pO_time,pO,xq,'spline');


            %plot the interpolation if needed
            %plot(rIFG_time,rIFG,'o',xq,rIFG_interp,':.'); hold on;

%extracting the times of the events            
Data = importfile1(char(files_long(i)));
Data=Data(strcmp(Data.Run, 'Money'),:);
trial_type=zeros(length(Data.Run),1);
    for row=1:length(Data.Run);
            if Data.Tooearlyresponses(row)>0;
                    start_time(row,1)=Data.AnticipationPhaseStartTime(row)/1000;
                    end_time(row,1)=Data.AnticipationPhaseStartTime(row)/1000+Data.AnticipationPhaseDuration(row)/1000;
                    trial_type(row,1)=1;
            elseif strcmp(Data.Outcome(row), 'SUCCESS');
                    start_time(row,1)=Data.AnticipationPhaseStartTime(row)/1000;
                    end_time(row,1)=Data.AnticipationPhaseStartTime(row)/1000+Data.AnticipationPhaseDuration(row)/1000;
            else start_time(row,1)=0;
                end_time(row,1)=0;
            end;
    end
    datamat=horzcat(start_time, end_time, trial_type); datamat=datamat(datamat(:,1)>0,:);
    trial_type=datamat(:,3); start_time=datamat(:,1); end_time=datamat(:,2);

%using the times of the events to extract activation for each ts for each
%event
    for trial=1:length(trial_type);
        trial_rIFG_interp = rIFG_interp(xq'>start_time(trial) &  end_time(trial)>xq');
        rIFG_activation(trial)=trapz(trial_rIFG_interp)/(end_time(trial)-start_time(trial));
               %plt=area(xq(xq'>start_time(trial) & xq'<end_time(trial)), trial_rIFG_interp); hold on
               %if trial_type(trial)==1; plt.FaceColor = [1 0 0]; elseif trial_type(trial)==0; plt.FaceColor = [0 0 1]; end
            rIFG_temp=acc_interp(xq'>(start_time(trial)-1)  &  (start_time(trial)+7)>xq');
            if length(rIFG_temp)<800; rIFG_temp((length(rIFG_temp)+1):800)=0; end
            rIFG_plot(trial, :)=rIFG_temp(1:700);
        trial_acc_interp = acc_interp(xq'>start_time(trial) &  end_time(trial)>xq');
        acc_activation(trial)=trapz(trial_acc_interp)/(end_time(trial)-start_time(trial));
       
        trial_CAU_interp = CAU_interp(xq'>start_time(trial) &  end_time(trial)>xq');
        CAU_activation(trial)=trapz(trial_CAU_interp)/(end_time(trial)-start_time(trial));
      
        trial_pO_interp = pO_interp(xq'>start_time(trial) &  end_time(trial)>xq');
        pO_activation(trial)=trapz(trial_pO_interp)/(end_time(trial)-start_time(trial));
        subject_id(trial)=i;
    end

%concatenate across subjects
    IFG_all=vertcat(IFG_all,rIFG_activation');
    acc_all=vertcat(acc_all,acc_activation');
    CAU_all=vertcat(CAU_all,CAU_activation');
    pO_all=vertcat(pO_all,pO_activation' );
    trial_type_all=vertcat(trial_type_all, trial_type);
    subject_id_all=vertcat(subject_id_all, subject_id');
         rIFG_plot_all=vertcat(rIFG_plot_all, rIFG_plot);
                                    %calucalte mean activation for and model premature vs correct in each person type
                                    meanact1_all(i)=mean(rIFG_activation(trial_type==1));
                                    meanact0_all(i)=mean(rIFG_activation(trial_type==0));
                                    pred_features=horzcat(rIFG_activation', acc_activation', CAU_activation', pO_activation');
                                    outcome=logical(trial_type);

                                    model1 = fitglm(pred_features,outcome,'Distribution','binomial','Link','logit');
                                    score_log = model1.Fitted.Probability;
                                    [Xlog,Ylog,Tlog,AUClog] = perfcurve(outcome,score_log,'true');
                                    AUC_all(i)=AUClog; betas(i)=model1.Coefficients{3,1};
                                    %plot(Xlog,Ylog, 'b'); hold on

%end interations over subjects
end
mean(AUC_all(36:76))



rIFG_plot_prem=rIFG_plot_all((trial_type_all==1),:); rIFG_plot_cor=rIFG_plot_all((trial_type_all==0),:);
figure; plot(mean(rIFG_plot_prem), 'r'); sem_prem=std(rIFG_plot_prem)/sqrt(239); sem_cor=std(rIFG_plot_prem)/sqrt(1342);
hold on; plot(mean(rIFG_plot_cor),'black'); 
plot(mean(rIFG_plot_prem)-1.96*sem_prem, ':r'); plot(mean(rIFG_plot_prem)+1.96*sem_prem, ':r'); 
plot(mean(rIFG_plot_cor)-1.96*sem_cor, ':black'); plot(mean(rIFG_plot_cor)+1.96*sem_cor, ':black');
x=[1:700];x2 = [x, fliplr(x)];
inBetweenred = [mean(rIFG_plot_prem)-1.96*sem_prem, fliplr(mean(rIFG_plot_prem)+1.96*sem_prem)];
fl1=fill(x2, inBetweenred, 'r');fl1.FaceColor = [1 0 0]; alpha(fl1,.1); 
inBetweenblack= [mean(rIFG_plot_cor)-1.96*sem_cor, fliplr(mean(rIFG_plot_cor)+1.96*sem_cor)];
fl2=fill(x2, inBetweenblack, 'black');fl2.FaceColor = [0 0 0]; alpha(fl2,.1); 
grid on; %difference sign? 
line([1 700], [0 0],'color','k','linewidth',3); %x-axis 
%line([100 500], [0 0],'color','k','linewidth',6); %x-axis 
line([100 100], [-.1 .2],'color','k','linewidth',1); ylim([-.1, 0.2]);
line([500 500], [-.1 .2],'color','k','linewidth',1); 


figure
plot(xq, rIFG_interp)
%plot(rIFG_time, rIFG-5)
hold on
yyaxis right
plot(start_time, trial_type)

figure
plot(rIFG_activation)
hold on 
yyaxis right
plot(trial_type)

AUC_all=AUC_all'
meanact0_all=meanact0_all'
meanact1_all=meanact1_all'
meanactD=meanact1_all-meanact0_all

mean(rIFG_activation(trial_type==1))
mean(rIFG_activation(trial_type==0))


%% DOES racc ACTIVATION PREDICT TRIAL TYPE????
y(1)=mean(IFG_all(trial_type_all==1))
y(2)=mean(IFG_all(trial_type_all==0))
errY(1)=(std(IFG_all(trial_type_all==1)))/sqrt(length(trial_type_all))
errY(2)=(std(IFG_all(trial_type_all==0)))/sqrt(length(trial_type_all))
    h = barwitherr(errY, y);% Plot with errorbars
    set(gca,'XTickLabel',{'Premature','Correct'})
    legend('Mean','SEM')
    ylabel('IFG activation')
    set(h(1),'FaceColor','k');

[h,p]=ttest2((IFG_all(trial_type_all==1)), (IFG_all(trial_type_all==0)))

nbins=25
figure
yyaxis left
h1=histfit(IFG_all(trial_type_all==1), nbins, 'normal')
h1(1).FaceColor=[0.5 0.5 0.5];
hold on
yyaxis right
histfit(IFG_all(trial_type_all==0), nbins, 'normal')

pred_features=horzcat(IFG_all,acc_all,CAU_all,pO_all)
outcome=logical(trial_type_all);

model1 = fitglm(pred_features,outcome,'Distribution','binomial','Link','logit');
score_log = model1.Fitted.Probability;
[Xlog,Ylog,Tlog,AUClog] = perfcurve(outcome,score_log,'true');
AUClog
plot(Xlog,Ylog, 'b'); xlabel('False positive rate'); ylabel('True positive rate'); title('ROC for Classification by Logistic Regression')


%% copying the par files
for i=36:76%length(files)
    input=cellstr(strcat('G:\Impulsivity_project\MID_169sub_sorted\', files(i), '\d5_nonlinear.feat\mc\prefiltered_func_data_mcf.par'));
    output=cellstr(strcat('G:\Impulsivity_project\DCM\MID\', files(i), '\prefiltered_func_data_mcf.par.txt'));
    copyfile(input{1}, output{1});
end
%if mod(str2num(files_short(1,:)),2)==1; %if the filename is odd [starts with money]; else %if the filename is even [starts with drug]
% PLOTTING OTHER CLASSIFIERS
modelSVM=fitcsvm(pred_features,outcome,'Standardize',true);
modelSVM= fitPosterior(modelSVM);
[~,score_svm] = resubPredict(modelSVM);
[Xsvm,Ysvm,Tsvm,AUCsvm] = perfcurve(outcome,score_svm(:,modelSVM.ClassNames),'true');

modelNB = fitcnb(pred_features,outcome);
[~,score_nb] = resubPredict(modelNB);
[Xnb,Ynb,Tnb,AUCnb] = perfcurve(outcome,score_nb(:,modelNB.ClassNames),'true');

plot(Xlog,Ylog)
hold on
plot(Xsvm,Ysvm)
plot(Xnb,Ynb)
legend('Logistic Regression','Support Vector Machines','Naive Bayes','Location','Best')
xlabel('False positive rate'); ylabel('True positive rate');
title('ROC Curves for Logistic Regression, SVM, and Naive Bayes Classification')
hold off